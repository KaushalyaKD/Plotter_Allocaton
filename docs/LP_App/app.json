[{"name":"app.R","content":"# Load libraries\r\n\r\nlibrary(shiny)\r\nlibrary(dplyr)\r\nlibrary(readxl)\r\nlibrary(tidyr)\r\nlibrary(lubridate)\r\nlibrary(openxlsx)\r\nlibrary(ggplot2)\r\nlibrary(patchwork)\r\nlibrary(munsell)\r\n\r\n# Increase upload limit to 100MB\r\noptions(shiny.maxRequestSize = 100*1024^2)\r\n\r\nui <- fluidPage(\r\n  \r\n  titlePanel(\"Laser Plotter Allocation System\"),\r\n  \r\n  sidebarLayout(\r\n    sidebarPanel(\r\n      \r\n      fileInput(\"file\", \"Upload Cutting.xlsx\", accept = \".xlsx\"),\r\n      \r\n      # Editable plotter pools\r\n      selectInput(\"poolsC\", \"Pools for Plotter C:\",\r\n                  choices = c(\"3Di\",\"TEXTILE\",\"SBOEM\",\"CUSUP-PK\",\"CUSUP-PK-L\",\"CUSUP-PK-G\",\r\n                              \"CUSDOWN\",\"ODUP\",\"ODUP-Pk\"),\r\n                  selected = c(\"3Di\",\"TEXTILE\"),\r\n                  multiple = TRUE),\r\n      \r\n      selectInput(\"poolsD\", \"Pools for Plotter D:\",\r\n                  choices = c(\"3Di\",\"TEXTILE\",\"SBOEM\",\"CUSUP-PK\",\"CUSUP-PK-L\",\"CUSUP-PK-G\",\r\n                              \"CUSDOWN\",\"ODUP\",\"ODUP-Pk\"),\r\n                  selected = c(\"TEXTILE\",\"3Di\",\"SBOEM\"),\r\n                  multiple = TRUE),\r\n      \r\n      selectInput(\"poolsG\", \"Pools for Plotter G:\",\r\n                  choices = c(\"3Di\",\"TEXTILE\",\"SBOEM\",\"CUSUP-PK\",\"CUSUP-PK-L\",\"CUSUP-PK-G\",\r\n                              \"CUSDOWN\",\"ODUP\",\"ODUP-Pk\"),\r\n                  selected = c(\"CUSUP-PK-L\",\"CUSUP-PK\",\"CUSUP-PK-G\",\"3Di\"),\r\n                  multiple = TRUE),\r\n      \r\n      selectInput(\"poolsI\", \"Pools for Plotter I:\",\r\n                  choices = c(\"3Di\",\"TEXTILE\",\"SBOEM\",\"CUSUP-PK\",\"CUSUP-PK-L\",\"CUSUP-PK-G\",\r\n                              \"CUSDOWN\",\"ODUP\",\"ODUP-Pk\"),\r\n                  selected = c(\"CUSDOWN\",\"ODUP-Pk\",\"ODUP\",\"3Di\"),\r\n                  multiple = TRUE),\r\n      \r\n      # Capacities\r\n      numericInput(\"capacityC\", \"Daily capacity - Plotter C:\", 10*16*0.6),\r\n      numericInput(\"capacityD\", \"Daily capacity - Plotter D:\", 15*16*0.6),\r\n      numericInput(\"capacityG\", \"Daily capacity - Plotter G:\", 10*16*0.6),\r\n      numericInput(\"capacityI\", \"Daily capacity - Plotter I:\", 15*16*0.6),\r\n      \r\n      actionButton(\"run\", \"Run Allocation\", class = \"btn-primary\"),\r\n      br(), br(),\r\n      \r\n      downloadButton(\"downloadExcel\", \"Download Excel Output\")\r\n    ),\r\n    \r\n    mainPanel(\r\n      tabsetPanel(\r\n        tabPanel(\"LP Allocation\", tableOutput(\"LP_table\")),\r\n        tabPanel(\"Summary\", tableOutput(\"summary_table\")),\r\n        tabPanel(\"Clustered Chart\", plotOutput(\"chart\")),\r\n        tabPanel(\"Pool Pie Charts\", plotOutput(\"pool_pie_charts\", height = \"900px\"))\r\n      )\r\n    )\r\n  )\r\n)\r\n\r\nserver <- function(input, output, session) {\r\n  \r\n  allocation_result <- eventReactive(input$run, {\r\n    \r\n    req(input$file)\r\n    \r\n    # Load Excel file\r\n    df <- read_excel(input$file$datapath) %>%\r\n      mutate(\r\n        ShipDate = as.Date(`Ship Date`),\r\n        Meters = suppressWarnings(as.numeric(`M90 - Laser(m)`))\r\n      ) %>%\r\n      filter(!is.na(Meters) & Meters > 0) %>%\r\n      arrange(ShipDate)\r\n    \r\n    # Editable pools from UI\r\n    plotter_Pools <- list(\r\n      C = input$poolsC,\r\n      D = input$poolsD,\r\n      G = input$poolsG,\r\n      I = input$poolsI\r\n    )\r\n    \r\n    # Editable capacities\r\n    daily_capacity <- c(\r\n      C = input$capacityC,\r\n      D = input$capacityD,\r\n      G = input$capacityG,\r\n      I = input$capacityI\r\n    )\r\n    \r\n    # Allocation function\r\n    allocate_plotter <- function(df, allowed_pools, capacity, used) {\r\n      plot_df <- df %>%\r\n        filter(Pool %in% allowed_pools,\r\n               !(`MO Number` %in% used)) %>%\r\n        arrange(ShipDate)\r\n      \r\n      if (nrow(plot_df) == 0) {\r\n        return(list(MOs = character(), Total = 0, Remaining = capacity))\r\n      }\r\n      \r\n      total <- 0\r\n      selected <- c()\r\n      \r\n      for (i in seq_len(nrow(plot_df))) {\r\n        meters_i <- plot_df$Meters[i]\r\n        if (total + meters_i <= capacity) {\r\n          selected <- c(selected, plot_df$`MO Number`[i])\r\n          total <- total + meters_i\r\n        }\r\n      }\r\n      \r\n      list(MOs = selected, Total = total, Remaining = capacity - total)\r\n    }\r\n    \r\n    # Master allocation\r\n    used <- c()\r\n    allocation_list <- list()\r\n    summary_list <- list()\r\n    \r\n    for (p in names(plotter_Pools)) {\r\n      result <- allocate_plotter(df, plotter_Pools[[p]], daily_capacity[p], used)\r\n      used <- c(used, result$MOs)\r\n      allocation_list[[p]] <- result$MOs\r\n      \r\n      summary_list[[p]] <- data.frame(\r\n        Plotter = p,\r\n        Total_MOs = length(result$MOs),\r\n        Total_Meters = result$Total,\r\n        Target_Meters = daily_capacity[p],\r\n        Remaining_Meters = result$Remaining\r\n      )\r\n    }\r\n    \r\n    max_rows <- max(sapply(allocation_list, length))\r\n    \r\n    LP_allocation <- data.frame(\r\n      C = c(allocation_list$C, rep(NA, max_rows - length(allocation_list$C))),\r\n      D = c(allocation_list$D, rep(NA, max_rows - length(allocation_list$D))),\r\n      G = c(allocation_list$G, rep(NA, max_rows - length(allocation_list$G))),\r\n      I = c(allocation_list$I, rep(NA, max_rows - length(allocation_list$I)))\r\n    )\r\n    \r\n    summary_output <- bind_rows(summary_list) %>%\r\n      mutate(Efficiency = round((Total_Meters / Target_Meters) * 100, 1))\r\n    \r\n    summary_cluster <- summary_output %>%\r\n      select(Plotter, Total_Meters, Target_Meters)\r\n    \r\n    summary_cluster <- rbind(\r\n      summary_cluster,\r\n      data.frame(\r\n        Plotter = \"TOTAL\",\r\n        Total_Meters = sum(summary_cluster$Total_Meters),\r\n        Target_Meters = sum(summary_cluster$Target_Meters)\r\n      )\r\n    )\r\n    \r\n    list(\r\n      LP_allocation = LP_allocation,\r\n      summary_output = summary_output,\r\n      summary_cluster = summary_cluster\r\n    )\r\n  })\r\n  \r\n  output$LP_table <- renderTable(allocation_result()$LP_allocation)\r\n  output$summary_table <- renderTable(allocation_result()$summary_output)\r\n  \r\n  # Clustered bar chart\r\n  output$chart <- renderPlot({\r\n    mat <- rbind(\r\n      allocation_result()$summary_cluster$Total_Meters,\r\n      allocation_result()$summary_cluster$Target_Meters\r\n    )\r\n    \r\n    bp <- barplot(\r\n      mat,\r\n      beside = TRUE,\r\n      col = c(\"steelblue\", \"green\"),\r\n      names.arg = allocation_result()$summary_cluster$Plotter,\r\n      main = \"Total Meters vs Target Meters\",\r\n      ylab = \"Meters\",\r\n      xlab = \"Plotter\",\r\n      ylim = c(0, max(mat) * 1.25),\r\n      las = 1\r\n    )\r\n    \r\n    text(x = bp, y = mat, labels = round(mat,1), pos = 3)\r\n    legend(\"topleft\", legend = c(\"Total Meters\", \"Target Meters\"),\r\n           fill = c(\"steelblue\", \"green\"))\r\n  })\r\n  \r\n  # PIE CHARTS\r\n  output$pool_pie_charts <- renderPlot({\r\n    \r\n    req(input$file)\r\n    \r\n    df_alloc <- allocation_result()\r\n    plotters <- c(\"C\",\"D\",\"G\",\"I\")\r\n    pie_list <- list()\r\n    \r\n    # Read original file once\r\n    original_df <- read_excel(input$file$datapath) %>%\r\n      mutate(MO = `MO Number`, Pool = as.character(Pool))\r\n    \r\n    for(p in plotters){\r\n      allocated_MOs <- df_alloc$LP_allocation[[p]]\r\n      allocated_MOs <- allocated_MOs[!is.na(allocated_MOs)]\r\n      \r\n      if(length(allocated_MOs) == 0){\r\n        pie_list[[p]] <- ggplot() +\r\n          annotate(\"text\", x=0, y=0, label=paste(\"Plotter\",p,\"\\nNo MOs allocated\")) +\r\n          theme_void()\r\n      } else {\r\n        temp <- original_df %>%\r\n          filter(MO %in% allocated_MOs) %>%\r\n          group_by(Pool) %>%\r\n          summarise(Count=n(), .groups=\"drop\") %>%\r\n          mutate(Percentage = round(100*Count/sum(Count),1),\r\n                 Label = paste0(Count,\" (\",Percentage,\"%)\"))\r\n        \r\n        pie_list[[p]] <- ggplot(temp, aes(x=\"\", y=Count, fill=Pool)) +\r\n          geom_col(width=1) +\r\n          coord_polar(\"y\") +\r\n          geom_text(aes(label=Label), position=position_stack(vjust=0.5), size=4) +\r\n          labs(title=paste(\"Plotter\",p,\"Pool Distribution\"),\r\n               subtitle=\"Count & Percentage of Allocated MOs\") +\r\n          theme_void() +\r\n          theme(plot.title=element_text(size=16,face=\"bold\",hjust=0.5),\r\n                legend.position = \"right\"\r\n          )\r\n      }\r\n    }\r\n    \r\n    patchwork::wrap_plots(pie_list, ncol=2)\r\n  })\r\n  \r\n  # Excel download\r\n  output$downloadExcel <- downloadHandler(\r\n    filename = \"Laser_Plotter_Allocation.xlsx\",\r\n    content = function(file) {\r\n      wb <- createWorkbook()\r\n      addWorksheet(wb,\"LP_Allocation\")\r\n      addWorksheet(wb,\"Summary\")\r\n      \r\n      writeData(wb,\"LP_Allocation\", allocation_result()$LP_allocation)\r\n      writeData(wb,\"Summary\", allocation_result()$summary_output)\r\n      \r\n      # Save chart\r\n      png(\"LP_chart.png\", width=1200, height=800)\r\n      mat <- rbind(\r\n        allocation_result()$summary_cluster$Total_Meters,\r\n        allocation_result()$summary_cluster$Target_Meters\r\n      )\r\n      barplot(mat, beside=TRUE, col=c(\"steelblue\",\"green\"),\r\n              names.arg=allocation_result()$summary_cluster$Plotter)\r\n      dev.off()\r\n      \r\n      insertImage(wb, \"Summary\", \"LP_chart.png\", startRow=2, startCol=8)\r\n      saveWorkbook(wb, file, overwrite=TRUE)\r\n    }\r\n  )\r\n}\r\n\r\nshinyApp(ui, server)","type":"text"}]
